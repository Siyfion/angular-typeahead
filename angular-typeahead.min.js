angular.module("siyfion.sfTypeahead",[]).directive("sfTypeahead",function(){return{restrict:"AC",require:"?ngModel",scope:{options:"=",datasets:"="},link:function(a,b,c,d){function e(a,b){var c=-1;return angular.forEach(a,function(a,d){angular.equals(b,a)&&(c=d)}),c>=0}function f(a){var b=0;if(a=a[0],document.selection){var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else"number"==typeof a.selectionStart&&(b=a.selectionStart);return b}function g(a,b){if(a=a[0],document.selection){var c=a.createTextRange();c.move("character",b),c.select()}else"number"==typeof a.selectionStart&&(a.focus(),a.setSelectionRange(b,b))}function h(b,c){a.$apply(function(){var a=!1;$.each(j,function(b,e){var f=e.displayKey||"value",g=(angular.isFunction(f)?f(c):c[f])||"";return a?!1:void(g&&(a=!0,k=c,d.$setViewValue(g)))})})}var i=a.options||{},j=(angular.isArray(a.datasets)?a.datasets:[a.datasets])||[],k=null;b.typeahead(a.options,a.datasets),d.$parsers.push(function(a){var b=angular.isObject(k);return i.editable===!1?(d.$setValidity("typeahead",b),b?k:void 0):b?k:a}),d.$formatters.push(function(c){if(angular.isObject(c)){var f=!1;return $.each(j,function(g,h){function l(h){var l=e(h,c);k=c,l?(d.$setViewValue(o),f=!0):d.$setViewValue(i.editable===!1?void 0:o),(f||g===j.length-1)&&setTimeout(function(){a.$apply(function(){b.typeahead("val",o)})},0)}var m=h.source,n=h.displayKey||"value",o=(angular.isFunction(n)?n(c):c[n])||"";return f?!1:o?void m(o,l):void l([])}),""}return c}),b.bind("typeahead:selected",function(b,c,d){h(b,c,d),a.$emit("typeahead:selected",c,d)}),b.bind("typeahead:autocompleted",function(b,c,d){h(b,c,d),a.$emit("typeahead:autocompleted",c,d)}),b.bind("typeahead:opened",function(){a.$emit("typeahead:opened")}),b.bind("typeahead:closed",function(){a.$emit("typeahead:closed")}),b.bind("typeahead:cursorchanged",function(b,c,d){a.$emit("typeahead:cursorchanged",b,c,d)}),b.bind("input",function(){var c=f(b);a.$apply(function(){k=null,d.$setViewValue(b.typeahead("val"))}),g(b,c)})}}});